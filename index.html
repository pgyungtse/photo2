<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å³æ‹å³å‚³</title>
  <style>
    * { box-sizing: border-box; }
    body { margin:0; padding:15px; font-family:sans-serif; background:#f0f0f0; }
    h1 { font-size:28px; margin:0 0 20px; text-align:center; }
    
    /* æ‰‹æ©Ÿç›´ç«‹æ™‚å¼·åˆ¶å–®æ¬„ */
    #cam { 
      width:100%; padding:20px; font-size:20px; 
      border:2px dashed #666; border-radius:12px; 
      background:#fff; cursor:pointer;
    }
    #preview { 
      width:100%; max-width:100%; border-radius:12px; 
      margin:20px 0; box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }
    #side { 
      margin-top:20px; padding:10px; 
      background:rgba(255,255,255,0.9); border-radius:12px;
      max-height:60vh; overflow-y:auto;
    }
    details summary { font-size:18px; padding:10px 0; }
    table { font-size:16px; }
    pre { font-size:13px; }
  </style>
</head>
<body>
  <h1>æ‰‹æ©Ÿå³æ‹å³å‚³</h1>

  <div style="text-align:center;">
    <label for="cam" style="display:inline-block;width:100%;padding:22px;font-size:24px;font-weight:bold;background:#555;color:#ffffff;border-radius:12px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.2);text-align:center;"> ğŸ“· æ‹ç…§ </label>
    <input type="file" accept="image/*" capture="environment" id="cam" style="display:none;">
   
    <br>
    <img id="preview" src="" alt="é è¦½ç…§ç‰‡">
  </div>

  <div id="side"></div>

<script>
  function escapeHtml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;').replace(/'/g, '&#039;');
  }

  document.getElementById('cam').onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById('preview').src = URL.createObjectURL(file);

    const side = document.getElementById('side');
    side.innerHTML = '<div style="padding:20px;background:#111;color:#fff;border-radius:12px;text-align:center;"><h3>â³ æ­£åœ¨è¾¨è­˜ç™¼ç¥¨â€¦</h3></div>';

    const f = new FormData();
    f.append('photo', file);

    try {
      const res = await fetch('/upload', { method: 'POST', body: f });
      const result = await res.json();
      side.innerHTML = '';

      if (result.code === 200) {
        const p = result.products?.products || [];
        side.innerHTML = `
          <div style="padding:20px;background:#042a00;color:#b7ffb7;border-radius:12px;">
            <h3>âœ… OCR æˆåŠŸ</h3>
            <p><strong>å•†åº—ï¼š</strong>${result.retail_outlet_name || 'ï¼'}</p>
            <p><strong>åœ°å€ï¼š</strong>${result.retail_outlet_address || 'ï¼'}</p>
            <p><strong>æ—¥æœŸï¼š</strong>${result.purchase_date || 'ï¼'}</p>
            <p style="font-size:28px;"><strong>ç¸½é¡ï¼š</strong> <span style="color:#ffd24d;">$${result.total_transaction_amount}</span></p>
            <p><strong>é …ç›®ï¼š</strong>${p.length} é …</p>
            <details><summary style="cursor:pointer;">å±•é–‹å“é …</summary>
              <table width="100%">
                ${p.length ? p.map(i=>`<tr><td>${i.product_name}</td><td align="right">${i.quantity} Ã— $${i.unit_price}</td></tr>`).join('') 
                  : '<tr><td>ç„¡å“é …è³‡æ–™</td></tr>'}
              </table>
            </details>
          </div>`;
      } else {
        side.innerHTML = `<div style="padding:20px;background:#3a0000;color:#ffb7b7;border-radius:12px;">
          <h3>âœ– ${result.code || res.status} éŒ¯èª¤</h3>
          <pre style="background:#000;padding:10px;border-radius:8px;overflow:auto;">${JSON.stringify(result, null, 2)}</pre>
        </div>`;
      }
    } catch (err) {
      side.innerHTML = '<div style="padding:20px;background:#3a0000;color:#ffb7b7;border-radius:12px;"><h3>âœ– ç¶²çµ¡éŒ¯èª¤</h3></div>';
    }
  };
</script>
</body>
</html>