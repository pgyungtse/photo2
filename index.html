<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å³æ‹å³å‚³</title>
  <style>
    * { box-sizing: border-box; }
    body { margin:0; padding:15px; font-family:sans-serif; background:#f0f0f0; }
    h1 { font-size:28px; margin:0 0 20px; text-align:center; }
    
    /* æ‰‹æ©Ÿç›´ç«‹æ™‚å¼·åˆ¶å–®æ¬„ */
    #cam { 
      width:100%; padding:20px; font-size:20px; 
      border:2px dashed #666; border-radius:12px; 
      background:#fff; cursor:pointer;
    }
    #preview { 
      width:100%; max-width:100%; border-radius:12px; 
      margin:20px 0; box-shadow:0 4px 12px rgba(0,0,0,0.2);
      display: none;
    }
    #side { 
      margin-top:20px; padding:10px; 
      background:rgba(255,255,255,0.9); border-radius:12px;
      max-height:60vh; overflow-y:auto;
    }
    details summary { font-size:18px; padding:10px 0; cursor: pointer; }
    table { font-size:16px; width: 100%; border-collapse: collapse; }
    table td { padding: 8px 4px; border-bottom: 1px solid #ddd; }
    pre { font-size:13px; }
    .success-box { padding:20px; background:#042a00; color:#b7ffb7; border-radius:12px; }
    .error-box { padding:20px; background:#3a0000; color:#ffb7b7; border-radius:12px; }
    .loading-box { padding:20px; background:#111; color:#fff; border-radius:12px; text-align:center; }
    .total-amount { font-size:28px; color:#ffd24d; font-weight: bold; }
  </style>
</head>
<body>
  <h1>æ‰‹æ©Ÿå³æ‹å³å‚³</h1>

  <div style="text-align:center;">
    <label for="cam" style="display:inline-block;width:100%;padding:22px;font-size:24px;font-weight:bold;background:#555;color:#ffffff;border-radius:12px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.2);text-align:center;"> 
      ğŸ“· æ‹ç…§ 
    </label>
    <input type="file" accept="image/*" capture="environment" id="cam" style="display:none;">
   
    <br>
    <img id="preview" src="" alt="é è¦½ç…§ç‰‡">
  </div>

  <div id="side"></div>

<script>
  document.getElementById('cam').onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;
    
    const preview = document.getElementById('preview');
    preview.src = URL.createObjectURL(file);
    preview.style.display = 'block';

    const side = document.getElementById('side');
    side.innerHTML = '<div class="loading-box"><h3>â³ æ­£åœ¨è¾¨è­˜ç™¼ç¥¨â€¦</h3></div>';

    const formData = new FormData();
    formData.append('photo', file);

    try {
      const res = await fetch('/upload', { 
        method: 'POST', 
        body: formData 
      });
      
      const result = await res.json();
      side.innerHTML = '';

      if (res.ok) {
        // æˆåŠŸéŸ¿æ‡‰ (200-299)
        const products = result.products || [];
        side.innerHTML = `
          <div class="success-box">
            <h3>âœ… OCR æˆåŠŸ</h3>
            <p><strong>å•†åº—ï¼š</strong>${result.retail_outlet_name || 'ï¼'}</p>
            <p><strong>åœ°å€ï¼š</strong>${result.retail_outlet_address || 'ï¼'}</p>
            <p><strong>æ—¥æœŸï¼š</strong>${result.purchase_date || 'ï¼'}</p>
            <p><strong>é›»è©±ï¼š</strong>${result.phone_number || 'ï¼'}</p>
            <p><strong>ç™¼ç¥¨è™Ÿç¢¼ï¼š</strong>${result.invoice_number || 'ï¼'}</p>
            <p><strong>æ¢ç¢¼ï¼š</strong>${result.barcode || 'ï¼'}</p>
            <p style="font-size:28px;"><strong>ç¸½é¡ï¼š</strong> <span class="total-amount">$${result.total_transaction_amount || 0}</span></p>
            <p><strong>é …ç›®ï¼š</strong>${products.length} é …</p>
            
            ${products.length > 0 ? `
              <details>
                <summary>å±•é–‹å“é …</summary>
                <table>
                  <tr>
                    <th align="left">å“å</th>
                    <th align="right">æ•¸é‡</th>
                    <th align="right">åƒ¹éŒ¢</th>
                  </tr>
                  ${products.map(item => `
                    <tr>
                      <td>${escapeHtml(item.product_name || '')}</td>
                      <td align="right">${item.quantity || 0}</td>
                      <td align="right">$${item.unit_price || 0}</td>
                    </tr>
                  `).join('')}
                </table>
              </details>
            ` : '<p>ç„¡å“é …è³‡æ–™</p>'}
            
            <details>
              <summary>åŸå§‹æ•¸æ“š</summary>
              <pre style="background:#000;padding:10px;border-radius:8px;overflow:auto;color:#b7ffb7;">${JSON.stringify(result, null, 2)}</pre>
            </details>
          </div>`;
      } else {
        // éŒ¯èª¤éŸ¿æ‡‰
        side.innerHTML = `
          <div class="error-box">
            <h3>âŒ è¾¨è­˜å¤±æ•—</h3>
            <p><strong>éŒ¯èª¤ä»£ç¢¼ï¼š</strong> ${result.code || res.status}</p>
            <p><strong>éŒ¯èª¤ä¿¡æ¯ï¼š</strong> ${result.error || 'æœªçŸ¥éŒ¯èª¤'}</p>
            ${result.details ? `
              <details>
                <summary>è©³ç´°éŒ¯èª¤ä¿¡æ¯</summary>
                <pre style="background:#000;padding:10px;border-radius:8px;overflow:auto;">${JSON.stringify(result.details, null, 2)}</pre>
              </details>
            ` : ''}
          </div>`;
      }
    } catch (err) {
      side.innerHTML = `
        <div class="error-box">
          <h3>âœ– ç¶²çµ¡éŒ¯èª¤</h3>
          <p>${err.message}</p>
          <p>è«‹æª¢æŸ¥ï¼š</p>
          <ul>
            <li>ä¼ºæœå™¨æ˜¯å¦æ­£åœ¨é‹è¡Œ (port 3003)</li>
            <li>ç¶²çµ¡é€£æ¥æ˜¯å¦æ­£å¸¸</li>
            <li>API_KEY æ˜¯å¦æ­£ç¢ºè¨­ç½®</li>
          </ul>
        </div>`;
    }
  };

  function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }
</script>
</body>
</html>